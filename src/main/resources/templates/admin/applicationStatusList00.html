<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>申請状況</title>
</head>
<body>
    <main>
        <h2>申請状況一覧</h2>
        <h3 th:if="${selectedExam != null}" th:text="${selectedExam.examName}"></h3>
        <p th:if="${errorMessage}" style="color: red;" th:text="${errorMessage}"></p>

        <a th:href="@{/admin/addExamTarget}">試験対象者を登録する</a>

        <section></section>
            <table border="1">
                <thead>
                    <tr>                    
                        <th>対象者氏名</th>
                        <th>学生番号</th>
                        <th>学年</th>
                        <th>楽器</th>
                        <th>申請状況</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="target : ${targetStatusList}">
                        <td th:text="${target.name}"></td>
                        <td th:text="${target.studentId}"></td>
                        <td th:text="${target.grade}"></td>
                        <td th:text="${target.instrument}"></td>
                        <td>
                            <span th:if="${target.applied}">
                            <span th:if="${target.applicationId != null}">
                                <a href="#" class="view-detail" th:data-id="${target.applicationId}">申請済み</a>
                            </span>
                            <span th:if="${target.applicationId == null}">申請済み（IDなし）</span>
                            </span>
                            <span th:unless="${target.applied}">未申請</span>
                        </td>
                </tr>
                </tbody>
            </table>
        </section>
    </main>
    
    <nav>
        <li><a th:href="@{/admin/examList}">試験情報へ戻る</a></li>
        <li><a th:href="@{/admin/adminMenu}">メニューへ戻る</a></li>
    </nav>
    
    <div id="modal" style="
        display:none; position:fixed; top:10%; left:20%; width:50%; 
        background:white; border:10px solid gray; padding:20px; 
        z-index:1000; box-shadow: 0 0 10px rgba(0,0,0,0.3); 
        border-radius: 20px;">
        <div id="modal-content">読み込み中…</div>
        <button onclick="closeModal()">閉じる</button>
    </div>
    <div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="closeModal()"></div>

    <script>
        function closeModal() {
            document.getElementById("modal").style.display = "none";
            document.getElementById("modal-overlay").style.display = "none";

            // モーダルが開いてたら履歴を戻す
            if (history.state && history.state.modalOpen) {
                history.back();
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".view-detail").forEach(el => {
                el.addEventListener("click", function (e) {
                    e.preventDefault();
                    const applicationId = this.dataset.id;

                    // 履歴に追加（戻るボタンで閉じる用）
                    history.pushState({ modalOpen: true }, "", `#application-${applicationId}`);

                    fetch(`/admin/applicationDetailFragment?applicationId=${applicationId}`)
                        .then(res => {
                            console.log("AJAX status:", res.status, res.statusText);
                            return res.text();
                        })
                        .then(html => {
                            console.log("AJAX response body:", html);
                            document.getElementById("modal-content").innerHTML = html;
                            document.getElementById("modal").style.display = "block";
                            document.getElementById("modal-overlay").style.display = "block";
                        })
                        .catch(err => console.error("Fetch error:", err));
                });
            });
        });

        // 戻るボタン押されたらモーダルを閉じる
        window.addEventListener("popstate", function (event) {
            if (event.state && event.state.modalOpen) {
                closeModal(); // モーダル閉じるだけ
            }
        });
    </script>

</body>
</html>

<!--
fetch(`/admin/applicationDetailFragment?applicationId=${applicationId}`)
                        .then(res => res.text())
                        .then(html => {
                            document.getElementById("modal-content").innerHTML = html;
                            document.getElementById("modal").style.display = "block";
                            document.getElementById("modal-overlay").style.display = "block";
                        });
-->